version: 2.1

jobs:
  test_against_mruby:
    parameters:
      version:
        description: "Version of mruby to test against"
        type: string
    environment:
      MRUBY_CONFIG: /project/.ci_build_config.rb
    working_directory: /project
    docker:
      - image: ruby:2.6.3
    steps:
      - checkout
      - run: apt-get update -qq && apt-get install -y -qq bison
      - run: git clone --depth 1 --branch << parameters.version >> https://github.com/mruby/mruby.git
      - run: |
          cd mruby
          ./minirake test

workflows:
  version: 2
  weekly:
    triggers:
      - schedule:
          cron: "0 5 * * 6"
          filters:
            branches:
              only:
                - master
    jobs:
      - test_against_mruby:
          version: "master"
  test:
    jobs:
      - test_against_mruby:
          version: "master"
